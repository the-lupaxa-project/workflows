name: Reusable Python CI for check-jobs.py

on:
  workflow_call:
    inputs:
      python-versions:
        description: "JSON array of Python versions to test against"
        required: false
        type: string
        default: '["3.10","3.11","3.12","3.13","3.14"]'
      paths:
        description: "Comma-separated list of files and/or directories to check"
        required: true
        type: string

permissions:
  contents: read

jobs:
  check-jobs:
    name: Check check-jobs.py
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    env:
      PATHS: ${{ inputs.paths }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Show Python version
        run: |
          python --version
          which python

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      - name: Install tooling (ruff, mypy, pytest)
        run: |
          python -m pip install ruff mypy pytest

      - name: Basic import / syntax check for paths
        run: |
          set -e

          echo "Paths to check: ${PATHS}"

          IFS=',' read -r -a PATH_ARRAY <<< "${PATHS}"

          for p in "${PATH_ARRAY[@]}"; do
            p="$(echo "${p}" | xargs)"  # trim
            [ -z "${p}" ] && continue

            if [ -f "${p}" ]; then
              echo "Syntax checking file: ${p}"
              python -m py_compile "${p}"
            elif [ -d "${p}" ]; then
              echo "Syntax checking directory (compileall): ${p}"
              python -m compileall "${p}"
            else
              echo "ERROR: Path '${p}' does not exist." >&2
              exit 1
            fi
          done

      - name: Ruff lint
        run: |
          set -e

          IFS=',' read -r -a PATH_ARRAY <<< "${PATHS}"
          ARGS=()

          for p in "${PATH_ARRAY[@]}"; do
            p="$(echo "${p}" | xargs)"  # trim
            [ -z "${p}" ] && continue
            ARGS+=("${p}")
          done

          if [ "${#ARGS[@]}" -eq 0 ]; then
            echo "No valid paths specified for Ruff; skipping."
            exit 0
          fi

          echo "Running Ruff on: ${ARGS[*]}"
          ruff check "${ARGS[@]}"

      - name: mypy type checking
        run: |
          set -e

          IFS=',' read -r -a PATH_ARRAY <<< "${PATHS}"
          ARGS=()

          for p in "${PATH_ARRAY[@]}"; do
            p="$(echo "${p}" | xargs)"  # trim
            [ -z "${p}" ] && continue
            ARGS+=("${p}")
          done

          if [ "${#ARGS[@]}" -eq 0 ]; then
            echo "No valid paths specified for mypy; skipping."
            exit 0
          fi

          echo "Running mypy on: ${ARGS[*]}"
          mypy "${ARGS[@]}"

      - name: Run pytest (if tests/ exists)
        run: |
          if [ -d "tests" ]; then
            echo "Running pytest against tests/ ..."
            pytest -v
          else
            echo "No tests/ directory found; skipping pytest."
          fi
