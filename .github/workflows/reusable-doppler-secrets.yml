name: Reusable Doppler Secret

on:
  workflow_call:
    inputs:
      project:
        required: false
        type: string
        default: "lupaxa-secrets"
      config:
        required: false
        type: string
        default: "prod"
      secret_key:
        required: true
        type: string
    secrets:
      DOPPLER_TOKEN:
        required: true
    outputs:
      secret_value:
        description: "Value of the requested secret key from Doppler"
        value: ${{ jobs.doppler.outputs.secret_value }}

jobs:
  doppler:
    runs-on: ubuntu-latest
    outputs:
      secret_value: ${{ steps.export.outputs.secret_value }}

    env:
      DOPPLER_PROJECT: ${{ inputs.project }}
      DOPPLER_CONFIG: ${{ inputs.config }}

    steps:
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Inject Doppler secrets into environment via JSON
        id: doppler
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          # Download all secrets for the specified project and config
          SECRETS_JSON=$(doppler secrets download \
            --project "$DOPPLER_PROJECT" \
            --config "$DOPPLER_CONFIG" \
            --no-override \
            --json)

          # Convert JSON to KEY=VALUE lines and feed into $GITHUB_ENV
          echo "$SECRETS_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> "$GITHUB_ENV"

      - name: Export requested secret for caller
        id: export
        env:
          REQUESTED_SECRET_KEY: ${{ inputs.secret_key }}
        run: |
          set -euo pipefail

          if [ -z "${REQUESTED_SECRET_KEY:-}" ]; then
            echo "secret_value=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${!REQUESTED_SECRET_KEY:-}" ]; then
            echo "Requested secret '$REQUESTED_SECRET_KEY' not found in env"
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          else
            echo "Found secret '$REQUESTED_SECRET_KEY'"
            echo "secret_value=${!REQUESTED_SECRET_KEY}" >> "$GITHUB_OUTPUT"
          fi
