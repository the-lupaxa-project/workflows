name: Reusable Doppler Secret

on:
  workflow_call:
    inputs:
      project:
        required: false
        type: string
        default: "lupaxa-secrets"
      config:
        required: false
        type: string
        default: "prod"
      secret_key:
        required: true
        type: string
    secrets:
      DOPPLER_TOKEN:
        required: true
    outputs:
      secret_value:
        description: "Value of the requested secret key from Doppler"
        value: ${{ jobs.doppler.outputs.secret_value }}

jobs:
  doppler:
    runs-on: ubuntu-latest
    outputs:
      secret_value: ${{ steps.fetch.outputs.secret_value }}

    steps:
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Fetch requested secret from Doppler
        id: fetch
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_PROJECT: ${{ inputs.project }}
          DOPPLER_CONFIG: ${{ inputs.config }}
          REQUESTED_SECRET_KEY: ${{ inputs.secret_key }}
        run: |
          set -euo pipefail

          if [ -z "${REQUESTED_SECRET_KEY:-}" ]; then
            echo "secret_value=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Ask Doppler for this one secret only, as plain text
          VALUE=$(doppler secrets get "$REQUESTED_SECRET_KEY" \
            --project "$DOPPLER_PROJECT" \
            --config "$DOPPLER_CONFIG" \
            --token "$DOPPLER_TOKEN" \
            --plain \
            --no-exit-on-missing-secret 2>/dev/null || true)

          # If Doppler didn't find it or it's empty, return empty output
          if [ -z "$VALUE" ]; then
            echo "Secret '$REQUESTED_SECRET_KEY' not found or empty in Doppler"
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          else
            echo "Secret '$REQUESTED_SECRET_KEY' found"
            # No extra quotes, just the raw value
            echo "secret_value=$VALUE" >> "$GITHUB_OUTPUT"
          fi
