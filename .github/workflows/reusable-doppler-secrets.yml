name: Reusable Doppler Secret

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      config:
        required: true
        type: string
      secret_key:
        required: true
        type: string
    secrets:
      DOPPLER_TOKEN:
        required: true
    outputs:
      secret_value:
        description: "Value of the requested secret key from Doppler"
        value: ${{ jobs.doppler.outputs.secret_value }}

jobs:
  doppler:
    runs-on: ubuntu-latest
    outputs:
      secret_value: ${{ steps.export.outputs.secret_value }}

    env:
      DOPPLER_PROJECT: ${{ inputs.project }}
      DOPPLER_CONFIG: ${{ inputs.config }}

    steps:
      - name: Install Doppler CLI
        run: |
          curl -Ls https://cli.doppler.com/install.sh | sh

      - name: Inject Doppler secrets into environment
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          doppler secrets get \
            --project "$DOPPLER_PROJECT" \
            --config "$DOPPLER_CONFIG" \
            --no-file \
            --format env >> "$GITHUB_ENV"

      - name: Export requested secret for caller
        id: export
        env:
          REQUESTED_SECRET_KEY: ${{ inputs.secret_key }}
        run: |
          set -euo pipefail

          if [ -z "${REQUESTED_SECRET_KEY:-}" ]; then
            echo "secret_value=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Bash indirect expansion: ${!VAR_NAME}
          if [ -z "${!REQUESTED_SECRET_KEY:-}" ]; then
            echo "Requested secret '$REQUESTED_SECRET_KEY' not found in env"
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          else
            echo "Found secret '$REQUESTED_SECRET_KEY'"
            echo "secret_value=${!REQUESTED_SECRET_KEY}" >> "$GITHUB_OUTPUT"
          fi
