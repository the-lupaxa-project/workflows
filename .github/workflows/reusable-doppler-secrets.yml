name: Reusable Doppler Secret

on:
  workflow_call:
    inputs:
      project:
        required: false
        type: string
        default: "lupaxa-secrets"
      config:
        required: false
        type: string
        default: "prod"
      secret_key:
        required: true
        type: string
    secrets:
      DOPPLER_TOKEN:
        required: true
    outputs:
      secret_value:
        description: "Value of the requested secret key from Doppler"
        value: ${{ jobs.doppler.outputs.secret_value }}

jobs:
  doppler:
    runs-on: ubuntu-latest

    steps:
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Inject Doppler secrets into environment
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_PROJECT: ${{ inputs.project }}
          DOPPLER_CONFIG: ${{ inputs.config }}
        run: |
          set -euo pipefail

          doppler secrets download \
            --no-file \
            --format env \
            -p "$DOPPLER_PROJECT" \
            -c "$DOPPLER_CONFIG" \
            -t "$DOPPLER_TOKEN" \
            >> "$GITHUB_ENV"

      - name: Export requested secret for caller
        id: export_secret
        env:
          REQUESTED_SECRET_KEY: ${{ inputs.secret_key }}
        run: |
          set -euo pipefail

          SECRET_VALUE="${!REQUESTED_SECRET_KEY:-}"

          if [ -z "$SECRET_VALUE" ]; then
            echo "Secret '$REQUESTED_SECRET_KEY' is missing in Doppler (or empty)"
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          else
            echo "Secret '$REQUESTED_SECRET_KEY' found"
            echo "secret_value=$SECRET_VALUE" >> "$GITHUB_OUTPUT"
          fi

    outputs:
      secret_value: ${{ steps.export_secret.outputs.secret_value }}
