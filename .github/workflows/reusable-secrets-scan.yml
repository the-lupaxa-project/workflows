name: Secret scan (reusable)

on:
  workflow_call:
    inputs:
      fail_on_leak:
        description: "Fail the job if any leaks are found"
        required: false
        default: true
        type: boolean
      config_path:
        description: "Optional custom gitleaks config path"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  secret-scan:
    name: Scan for secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0  # allow scanning history or PR diff

      - name: Run Gitleaks (official)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2.3.9
        with:
          args: >
            detect
            --source=.
            --no-banner
            --report-format=json
            --report-path=gitleaks-report.json
            ${{ inputs.config_path != '' && format('--config={0}', inputs.config_path) || '' }}

      - name: Upload Gitleaks report (artifact)
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          if-no-files-found: ignore

      - name: Fail build on leaks
        if: ${{ inputs.fail_on_leak }}
        run: |
          if [ -s gitleaks-report.json ]; then
            echo "Secrets detected by Gitleaks. See gitleaks-report.json artifact for details."
            exit 1
          else
            echo "No secrets detected by Gitleaks."
          fi
