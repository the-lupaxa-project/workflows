name: Reusable Slack Workflow Status

on:
  workflow_call:
    inputs:
      include_jobs:
        description: >
          "true" (all jobs), "false" (no jobs), "on-failure" (jobs only if failure)
        required: false
        type: string
        default: "true"
      include_commit_message:
        description: "Include the commit message in the notification."
        required: false
        type: boolean
        default: true
      notify_on_results:
        description: >
          Comma-separated list of results to notify on (e.g. "failure,cancelled,timed_out").
          Use "all" to notify on every result.
        required: false
        type: string
        default: "all"
      ignore_jobs:
        description: >
          Comma-separated list of job names to exclude from the per-job Slack fields.
          Names are normalised (segment after the last "/") and matched
          case-insensitively.
        required: false
        type: string
        default: ""
    secrets:
      slack_webhook_url:
        required: true

permissions:
  actions: read
  contents: read

jobs:
  slack-workflow-status:
    name: Slack Workflow Status
    runs-on: ubuntu-latest
    if: >
      always() &&
      (
        github.event_name != 'pull_request' ||
        github.event.pull_request.head.repo.full_name == github.repository
      )

    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          repository: the-lupaxa-project/workflows
          path: lupaxa-dotgithub

      - name: Post workflow status to Slack (Python)
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
          SEND_TO_SLACK_RESULTS: ${{ inputs.notify_on_results }}
          SEND_TO_SLACK_INCLUDE_JOBS: ${{ inputs.include_jobs }}
          SEND_TO_SLACK_INCLUDE_COMMIT_MESSAGE: ${{ inputs.include_commit_message }}
          SEND_TO_SLACK_IGNORE_JOBS: ${{ inputs.ignore_jobs }}
        run: |
          python lupaxa-dotgithub/.github/scripts/send-to-slack.py
